from textwrap import dedent

import pytest
import nacl.signing

from sigmon.sigsum import TreeHead, InclusionProof
from sigmon.utils import sha256

LOG_KEY_RAW = bytes.fromhex('0ec7e16843119b120377a73913ac6acbc2d03d82432e2c36b841b09a95841f25')
LOG_KEY_HASH = sha256(LOG_KEY_RAW)
LOG_KEY = nacl.signing.VerifyKey(LOG_KEY_RAW)


def test_parse_treehead():
    ascii_ = dedent("""
    size=12851
    root_hash=4ccedda0c3e6afc83cfcddfad7df3d95cbd1e857ecf3cf0569b8f69ce32727f8
    signature=880207e73dbe7aa11ebab8118d4da67e59a2ff29d9b11e98b8d5d4062dbd4d12765b5389b4f0583130fa8573cf997d60b94c9e4d700469aba5a9f4383f619509
    cosignature=768c9aac6ea5ee9b9c75dd862b70dcb693a2cb37c4ae2f15064e34a1ab260b01 1754020861 bb50b9e163bb1854c5634ebbdd32e3e23142390e08272f0773d187f51386cfdd81d1ad74ae708f55964edcd2d415f44eaaa4967418839ac13aba6db0e7ac750e
    cosignature=3573fb7fdab7434cd0dad9fd6460abf420388055db8aaaec177c248f03a990cc 1754020861 aaddf982992263fbf18e5bd0c987dce77e4dcb6d1839a7120693fc027adbfe2874c4a17f86e9da66a74e2bde7936dc762b66ce07229ef3424ef330dbc586960c
    cosignature=6d6a78191e59815eff9131941fc3e08dd716a281c8b886dd67880d552e587a23 1754020863 b4b53936c7f158cbd207dd673cc05980b4fec81fa9646135f4bb0de8b2149d502ab9447a393c8432ce7c3d690ecf615640d9e6b7a9ba30bbc7351599cabb4702
    cosignature=b24254eb2c769e3c9f40b4268cd92b30cdb58c5a3c65e4f09f6475a6487e56d0 1754020862 f26139b4a9de9f09e1f874990428b92f236d185d80abb48a4140eb8349bab81fa93144d9d1a9e68f9a56429f9f46984ad0a6d3f6eddb0d601cb7d36fcb2a6105
    cosignature=6bdf03b285fce48e00ff9b199cb2b77472dcc4a112f067fa5b274929cb9504e3 1754020861 9ab58c0f6cbfd02549891b3b9d7e68fd7fefd42b6dc22fbbee7ed3119d1ed1807edc74c8b12fd430e4ee6084b59077d4c8eafe09eefdbbe31666828c34d24702
    cosignature=5da2b3803c2f802eed9744b74e3e4a3d31e1e77ed994ef56730d57fa52f698a5 1754020861 82f16ff572ba54e6f0b2f27e0e34fa729ab42d566b1d54a0b689d345c373fd0d87a61a6b6e81b4d17b3ca9f13f01a6c1325d701e6350ecddfa54b6b453691d0f
    cosignature=0dad9d849c57687454f100d87fa729b54cb69f7af97346613348defcba9c361c 1754020861 442f4e9a466a60de8cc706ff6d01acd0150c86ec915128ab36375cd3ee013b13675e96c2c2e83abb1b8992824b05f9eefe4afe3f046e7b491897da7dc395570d
    cosignature=9a0dcddbd96f6d6d404227b5ff23de7a43f25cdde9790af5ace332d347fac49a 1754020861 1a7cb189ca8bdac6743d1ed2d77fa7012509e6deebe2aee070221e860d51ab17c038ba493a27748922dc100299d8068dcb82397dd80efc679dfbf4b46b9b0a00
    cosignature=d59098d686f47ec1d4d1984c8ac0ab97a3d8a65c7ba8cb6422ada0fae927e194 1754020861 0177a303e75ddaef7aeff9ed8a50218866b431328d4ea5d9cae7eaae9d935a3c03102b5df23e1d4e0303c773ea84d1978189c2d4e8adb3ad815f9169dcbced05
    cosignature=0b00d26b3bf3e0ded29f82803abd34c972cb62752305b0e718cf7b8ec1bf99f6 1754020861 0e938f0d3935e9842855191a799336584afb47986848bc6312bdcd45606cbf2ac042b8a416db1381bf6f4b9e7a084de982b1ddb4704d53253deaf415f60e320a
    cosignature=0de5858fa7d8770c17cd17decf4d6345120736308786885b3623bcb852324416 1754020861 9b01158eb701ca6cd814f603918ba32c59a1b3618cfbf94090e5d8c0ee978559570510867135a596c9cd9944cf4bf4f300206f613aaa9eab3f92f8a68fed6b0d
    cosignature=81538d254f0a67aa07172826ef46fe0cd04b7425bd634a50bb0a8419d55fa65f 1754020861 02a7141b0dd172972a3a0f127218546d4a760479b995d02c4691022e60898bd14ec7f8c260dd6f3f1b2edab206c7806c3efe587ac0b1a9201889437bf4c1d10e
    cosignature=cd02db1cc0488c28245d7c3ff50b3e214334c067f2571e849425146bb6bd173d 1754020861 ade49be9a8f1b5633cd7675f8f94ce00ec398a3fd5b96d77dfaa960b4ed78584d99379db73c54ef5ecf7bfeacc744345a0dcf5588ca4febf313af6ffe05c090e
    cosignature=f7a8e45707ef65b294a899fd6a8f463b663e843f68c829bc00447171a582de24 1754020861 12fb3c6e7732a6e8f6fea8e8adf2e07826118914ad05be55b9803fdbf309ff479569bec38cea16367b7dce8f0f5899881f6c8bef0a1f49bb579f140eea9a3707
    cosignature=f6f91669f7955f542718af9edb6a1276d88a0f8822cba9046e549d0b3796f394 1754020861 573c856a7e7cd3f1f764911c7ee70cc14677928405d7b82c531e882322eb38a94bc6aa738856613109f49c05d3af5ccc24b989be591fb19d7827a1bfa9e27d07
    cosignature=506972ae99f752df639c749ac50a741b80d95f114a35420838ac06107ea9bfe8 1754020861 bcaaff25f70a04bc2d08d0c428e595d80cac19eb9f68dd65e95f5d0d2c16c3185252c4f30f7ae7dca861fee34a7661643d116a00bcf2c8fc97d8d3cbae34a70b
    cosignature=ff2f237a707a2d3a6adfb1600d3375cafe4527ba4fcec793e6093b9b1a4bd79a 1754020861 308e724f50b9ada63a2bfd9b0143345aa1ea3a793d4db4de1e4842d9643d926b8a6711017482f5bebbfb0fefe4e3f620151b5ef020ad30569595094563465000
    """)

    th = TreeHead.from_ascii(LOG_KEY_HASH, ascii_)
    assert th.size == 12851
    assert th.root_hash == bytes.fromhex('4ccedda0c3e6afc83cfcddfad7df3d95cbd1e857ecf3cf0569b8f69ce32727f8')
    assert len(th.cosignatures) == 17

    LOG_KEY.verify(th.commitment().encode(), th.signature)

def test_parse_treehead_no_cosig():
    ascii_ = dedent("""
    size=12851
    root_hash=4ccedda0c3e6afc83cfcddfad7df3d95cbd1e857ecf3cf0569b8f69ce32727f8
    signature=880207e73dbe7aa11ebab8118d4da67e59a2ff29d9b11e98b8d5d4062dbd4d12765b5389b4f0583130fa8573cf997d60b94c9e4d700469aba5a9f4383f619509
    """)

    TreeHead.from_ascii(LOG_KEY_HASH, ascii_)


def test_parse_treehead_bad():
    ascii_ = dedent("""
    size=-1
    root_hash=4ccedda0c3e6afc83cfcddfad7df3d95cbd1e857ecf3cf0569b8f69ce32727f8
    signature=880207e73dbe7aa11ebab8118d4da67e59a2ff29d9b11e98b8d5d4062dbd4d12765b5389b4f0583130fa8573cf997d60b94c9e4d700469aba5a9f4383f619509
    """)

    with pytest.raises(Exception):
        TreeHead.from_ascii(LOG_KEY_HASH, ascii_)


def test_parse_inclusion_proof():
    ascii_ = dedent("""
    leaf_index=2062
    node_hash=46476e59a8ce1aa665a415c5e069e828e56e9c15f9f02b7da82cb059bf3c1ae8
    node_hash=594cf74511d1aeafc981160f7226cc67893246722a1d820c7e1245c684f658b6
    node_hash=0439ce916cf13455c1dec507ce8e6ae44e7443ffd611044424d9cc080591387d
    node_hash=c83420a707810b251a145f460d4cb6191fd68910d68190a8685b7ce9bf4d5c5a
    """)

    ip = InclusionProof.from_ascii(ascii_)
    assert ip.leaf_index == 2062
    assert len(ip.node_hashes) == 4
